# Practical Malware Analysis Notes

## Ch. 6 Recognizing C Code Construct In Assembly

`Successful reverse engineers do not evaluate each instruction individually unless they must.`

### Global vs. Local Variables

- While declared similarly in C, they look different in assembly.
- Global variables are referenced by memory addresses. dword_40CF60
- Local variables are referenced by stack addresses. [ebp-8h]

### Disassembling Arithmetic Operations

```
int a = 0;  ->  mov  [ebp+var_4], 0  
int b = 1;  ->  mov  [ebp+var_8], 1   
a = a + 11; ->  mov  eax, [ebp+var_4] 
            ->  add  eax, 0Bh
            ->  mov  [ebp+var_4], eax
a = a - b;  ->  mov  ecx, [ebp+var_4]
            ->  sub  ecx, [ebp+var_8] 
            ->  mov  [ebp+var_4], ecx
a--;        ->  mov  edx, [ebp+var_4]
            ->  sub  edx, 1 
            ->  mov  [ebp+var_4], edx
b++         ->  mov  eax, [ebp+var_8]
            ->  add  eax, 1 
            ->  mov  [ebp+var_8], eax
b = a % 3;  ->  mov  eax, [ebp+var_4]
            ->  cdq
            ->  mov  ecx, 3
            ->  idiv ecx
            ->  mov  [ebp+var_8], edx
```

### Recognizing If Statements

- If statements must have a conditional jump instruction but not all conditional jumps go to if statements.
- Decisions on whether to jump are commonly made with a comparison instruction directly before the jump instruction. A second jump instruction shortly after the first is often used to skip the ELSE section of the statement.

### Recognizing Nested If Statements

- Look for cmp and jump instructions close together. Check if they are nested by following execution paths and/or use graph mode.

### Recognizing Loops

- For loops have 4 components
    + initialization
    + comparison
    + execution instructions
    + increment/decrement
- Look for the 4 components in the assembly
- In graph mode loops are best recognized by an upward direction arrow. 

### Finding While Loops

- While loops will look similar to for loops but will lack the increment component. 
- There will be an unconditional and a conditional jump. The loop exits when the condition jump is taken. 

### Understanding Function Call Conventions

- Calling conventions determine:
    + What order parameters are placed on the stack.
    + What parameters are placed in registers.
    + Whether the callee is responsible for cleaning the stack when the function is complete.
- Calling convention depends on the compiler and the code.
- Three most common calling conventions: cdecl, stdcall, fastcall
- cdecl:
    + Parameters are pushed on the stack from right to left.
    + Caller cleans up the stack.
    + Return value is stored in EAX.
- stdcall:
    + Parameters are pushed on the stack from right to left.
    + Callee cleans up the stack.
    + Standard calling convention for Windows API.
- fastcall:
    + Typically the first two arguments are passed in registers, normally edx and ecx.
    + Additional arguments are loaded right to left.
    + Usually caller is responsible for cleaning the stack.
    + Often more efficient do to less code interaction with the stack.

### Push vs. Move

- Compilers can choose to push arguments to the stack or move them to the stack. 
- In the case of using Move instructions there will be no adjustment of the stack pointer.

### Analyzing switch Statements

- Switch statements can be compiled in an if style or using jump tables.
- If Style: 
    + Many comparisons and conditional jumps.
    + Can't differentiate  between switch and nested If statements.
- Jump Table:
    + Usually found with large switch statements.
    + Jump table defines offsets to memory locations.
    + Switch variable is the index into the jump table.

### Disassembling Arrays

- Arrays are accessed using a base address.
- The size of elements can be figured out by looking at how the array is being indexed.

### Identifying Structs

- Create structures and assign them to memory with the T key

### Analyzing Linked List Traversal

- Linked list do not force an order based on how the data is stored therefore insertion and removal of nodes at any point.
- Look for objects that contains a pointer that points to an object of the same type.

### Conclusion

- Abstract your self from the details. 
- Donâ€™t get bogged down in the low-level details, but develop the ability to recognize what the code is doing at a higher level.

### Other

- Function epilogue is the portion of a function responsible for cleaning up the stack and returning.
- The struggle of taking assembly back to source code is there are many high-level ways to represent the same code.
- Malware sometimes uses an array of pointers to strings that contain
multiple hostnames that are used as options for connections.


### Definitions: 

- Code construct - code abstraction level that defines a functional property but not the details of it implementation. (Ex: loops, if statements,linked lists, switch statements,... )
- Global Variables: Variables that can be accessed and used by any function.
- Local Variables: Variables that can only be accessed by the function in which they are defined.
- Arrays: Used by programmers to define an order set of similar data items.
- Structures: Similar to arrays but the are comprised of elements of different types.
- Linked List: A data structure consisting of a sequence of data records, each record includes a link to the next.

### Tools:

- IDA Pro