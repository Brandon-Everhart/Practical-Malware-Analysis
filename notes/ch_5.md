# Practical Malware Analysis Notes

## Ch. 5 IDA Pro

### Loading an Executable

1. IDA will attempt to recognize file format and processor architecture.
2. IDA maps the file into memory like it was running. It can be useful to disassemble the raw binary because malware writers can append malicious data/code to the end of legitimate files. This extra data/code would be missed when loading into IDA.
3. If shellcode is expected load the file as a binary file.
4. PE files are compiled to load at a base address, if this address is taken the loader will preform a rebasing. If a DLL loads into a process different than what you see in IDA use Manual Load.
5. IDA leaves out PE header and resource sections; To look for malicious code in these sections also use Manual Load.

### The IDA Pro Interface

1. Switch between graph disassembly and text disassembly with the space bar.
2. Add line numbers and operation codes.
    - Options -> general -> line prefixes -> Set number of opcode bytes to 6.
    - Instruction Indentation to 8
3. IDA Auto comments feature
    - Options -> general -> Auto comments
4. Useful Windows: 
    - Functions window
    - Names window
    - Strings window
    - Imports window
    - Exports window
    - Structures window
    - These windows include the cross-reference feature.
5. Most common types of links:
    - Sub links: Start of functions such as printf and sub_4010A0
    - Loc links: Jump destinations such as loc_40107E
    - Offset links: Links to offsets in memory.
6. Navigation Band repersents a color coded linear view of the binarys address space. 
    - Light Blue: FLIRT
    - Red: Complier generated code
    - Dark Blue: User written code
7. Press the G key to jump to any virtual address.
8. Searching can be use to find specific text, the next instruction of your choosing, or a sequence of bytes.

### Using Cross-Refernces 

1. To see all the xrefs for a function click the function name then press X on the keyboard.

### Analyzing Functions

1. Prefixes: 
    - var_ : Variables
    - arg_ : Arguments
2. Suffixes correspond to their offset to EBP.
3. Local variables will have a negative offset from EBP and arguments will have a positive.
4. Create a function by pressing P.
5. Instructions "mov [ebp-0Ch], eax" and "push dword ptr [ebp-010h]" might appear instead of IDA identifying EBP-based stack frame. 
    - This may be fixed with: ALT-P -> BP Based Frame -> 4 Bytes for saved registers. 

### Using Graphing Options

1. These graphs cannot be manipulated by IDA.
2. Graph options:
    - Flow chart of current function
    - Function calls for entire program
    - xrefs to get a currently selected xref
    - xrefs from the currently selected symbol
    - A user specified sref graph

### Enhancing Disassembly

1. `IDA has no undo feature!`
2. Renaming Locations: Change dummy names to something meaningful and it will propagate through out IDA. 
3. Comments: To add comments select a line then press colon :. Repeated comments can be made using by pressing ;
4. Formatting operands: Change hex values to more meaningful data types such as decimal.
5. Use the U key and C key to un-define and define code segments.

### Extending IDA with Plug-ins

1. Python and IDC scripting.
2. IDAPyhton fully integrated into IDA pro.    

### Other

- Cell phone malware is often made for various platforms.

### Definitions: 

- IDA Pro: Interactive Disassembler Professional distributed by Hex-Rays.
- FLIRT: Fast Library Identification and Recognition Technology, code signatures used to recognize/label/disassemble compiler added code.
- xref: Cross-References 
- IDC: IDA pros built in scripting language

### Tools:

- IDA Pro

