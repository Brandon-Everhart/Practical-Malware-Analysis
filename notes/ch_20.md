# Practical Malware Analysis Notes

## Ch. 20 C++ Analysis

### Object-Oriented Programming

- C++ is OO programing
- Use a class to create an object of the class.
- Objects, Classes, Methods, Members, Instances.
- Data and functions are associated with objects.
- Access data in the following manner: ObjectName.variableName
- Access functions in the following manner: ObjectName.functionName
- This pointer keeps track of which memory address to access when accessing variables and functions.
- If an object is not specified the this pointer is always implied.
- Microsoft-generated assembly code generally passes the this parameter in the ECX register and sometimes ESI.
- The C++ calling convention for this pointer is often called thiscall.
- Identify the thiscall convention and you know you have OO code.
- When a function is called the complier determines which function to call based on parameter types.
- Name mangling is used to allow overloading.
- Child classes inherit functions and data from the parent classes. 
- Inheritance is commonly used to save on code reuse but generally isn't visible in assembly.

### Virtual vs. Non-virtual Functions

- A function defined in a parent class has a child class with a function of the same name the child function overwrites the parent function.
- Programming models use this to simplify complex programming tasks.
- Example: 
    + Socket class
        * TCP Sub class
        * UDP Sub class
- When a new socket protocol is invented we can simply add the new protocol as a sub class of socket.
- Non-virtual function execution is determined at runtime.
- Often called polymorphism, this allows functions that perform different functionality to share a common interface.
- C++ compiler adds data structures to handle virtual functions (vtables).
- Each class has a vtable and each virtual function has its own entry in the vtable.
- The biggest difference in virtual functions in the assembly is that we can't see the destination of the call instruction.
- To identify the call destination first determine the type of object and locate the vtable.
- The new operator will typically lead to the address of the vtable.
- Vtable looks like an array of function pointers.
- Only the first value in the table will have a xref because the other elements are accessed by there offset from the first one. And there is no direct access in to the table.
- Recognize virtual functions by there xrefs because they are not directly called by other parts of code, therefore you should see no call instructions to the virtual function.
- Identifying a vtable means you know all those functions come from the same class. And that functions in a class should be related. In this way you can start to determine if class relationships exist. 
- Two xrefs from two vtables suggest an inheritance relationship. 
- If one vtable is larger than another it is possibly a subclass.

### Creating and Destroying Objects

- Constructors performs initialization for objects.
- Objects can be created on the stack or stored in the heap.
- Destructor are automatically called when the object goes out of scope.
    + This can complicate the assembly by the complier added exception handling code.
- For an object not stored on the stack the new operator is used to create heap space.
- This new operator is normally an imported function that can be easily spotted.


### Conclusion

- OO
- vtables
- inheritance
- this pointer
- overloading
- name mangling 
- virtual functions
- constructor/destructor
- new operator 

### Other

- Malware usually has the internal symbols removed.

### Definitions: 

- OO: Object Oriented programming language using objects containing data and functions manipulate data. 
- Methods: Functions inside of C++ Classes.
- Classes: User defined data types. Store function information and data.
- Instance: An object of a class is an instance of the class.
- Method Overloading: Multiple functions with the same name that accept different parameters. 
- Name Mangling: Names in the file format are modified to include parameter info.
- Inheritance: Parent-child relationships are established between classes.
- Virtual Function: A function that can be overridden by a subclass and whose execution is determined at runtime.
- vtables: Virtual Function Tables, Arrays of function pointers.
- Constructor/Destructor: Special functions for creating and destroying objects.

### Tools:

