# Practical Malware Analysis Notes

## Ch. 2 Malware Analysis in Virtual Machines

`BEFORE RUNNING MALWARE YOU MUST SET UP A SAFE ENVIRONMENT!`

### Physical Machine Analysis

- One must use an air gapped network when running the malware on a physical machine.
- Advantages:
    + Real environment. (Some malware can detect if the environment is virtual)
- Disadvantages:
    + Some malware require Internet connection
    + Difficult to remove the malware. (Use a tool such as Norton Ghost for machine backups)

### Virtual Machine Analysis

- A virtual machine is a computer inside of a computer. The virtual machine OS is isolated from the host machines OS. (Malware should not be able to harm the host OS)
- Make sure the host machine is up to date.
- When creating a VM for analysis a 20GB hard drive is a good start.
- If using VMware make sure to install VMware tools.
- You can disconnect the virtual machine from the network completely but this is not always what we want. Often times we will want to look at the malware's network activity.
- Use a host-only LAN to allow the malware so network activity but no access to the Internet. The VM will connect to a virtual network adapter never touching the host network adapter.
- Set up a restrictive firewall to the host from the virtual machine.

### Multiple VM's Analysis

- Two virtual machines connected by a LAN but no connection to the host. This allows network activity, while the malware is not connected to anything important.
- One of the VMs would be setup for analysis while the other is setup for services.
- The two virtual machines get connected to a VMNet virtual switch.
- When using multiple VMs for analysis it is helpful to combine the machines as a virtual machine team.
- The VM set up for services is used to simulate the network connections that the subject malware is trying to connect to. Such as HTTP and DNS servers.

### Internet

`NEVER CONNECT MALWARE TO THE INTERNET WITHOUT FIRST ANALYZING WHAT THE MALWARE MAY DO.`

- Two common ways to connect the malware VM to the Internet: Bridged network adapter and VMware Network Address Translator mode.

### Conclusion

1. Clean Snapshot
2. Move Malware to VM
3. Analyze
4. Move research to physical machine
5. Revert VM to clean Snapshot

### Other

- Most malware is written for Windows XP as of 2012
- Zero-day exploits can still harm the host machine while inside the VM.
- After setting up the VMs take a snapshot.
- VMware Record and Replay feature


### Definitions: 

- Air-gapped networks: Isolated networks of machines disconnected form the Internet and other networks.
- Bridged Network Adapter: Connects the virtual machine to the same network interface as the host machine. 
- Host-only networking: A private LAN between the host OS and VM guest OS.
- Network Address Translation: The host acts like a router and tranlstes all the requests that come from the VM making them look like they came from the host.
- Shared Folders: A folder accessible from both the VM and Host.
- Snapshot: Save the VMs current state and return to it later.
- Virtual Machine Team: Joins multiple VMs together and allows you to manage power, network,and settings together.

### Tools:

- Norton Ghost
- VMware Player (free)
- VMware Workstation ($200, better choice for malware analysis)
